# Djangoで動物分類アプリ

## どんな機能を付けるか

- カスタムユーザーでのユーザー認証機能
- 画像投稿機能
- Chainerでの画像分類機能(後にPytorch化を予定)
- Ajaxで分類結果表示を目指す。

## Procedure

### 1. プロジェクトを開始する

```sh
# 仮想環境の構築
python -m venv venv-animal

# 仮想環境の有効化
venv-animal/Script/actiavte

# モジュールのインストール
python -m pip install --upgrade pip setuptools
pip install django python-dotenv django-allauth django-crispy-forms

# djangoのプロジェクトを開始する
django-admin startproject config .

# .envファイルの作成
type nul > .env

# templatesフォルダの作成
mkdir templates
cd templates
mkdir account # all-auth用
cd ../ # プロジェクトrootに戻る

# staticフォルダの作成
mkdir static
cd static
mkdir css
mkdir js
mkdir image
cd ../ # プロジェクトrootに戻る

```

基本的なフォルダ構成を作成した。

つづいてsettings.pyを更新する。

```python
# config/settings.py
"""
Django settings for config project.

Generated by 'django-admin startproject' using Django 3.0.1.

For more information on this file, see
https://docs.djangoproject.com/en/3.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.0/ref/settings/
"""

import os
from dotenv import load_dotenv  # 追加

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
PROJECT_DIR = os.path.basename(BASE_DIR)

# .envの読み込み
load_dotenv(os.path.join(BASE_DIR, '.env'))

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.getenv('SECRET_KEY')

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ['*']  # 変更


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

SITE_ID = 1  # 追加

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'templates')],  # 変更
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'


# Database
# https://docs.djangoproject.com/en/3.0/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}


# Password validation
# https://docs.djangoproject.com/en/3.0/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/3.0/topics/i18n/

LANGUAGE_CODE = 'ja'  # 変更

TIME_ZONE = 'Asia/Tokyo'  # 変更

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.0/howto/static-files/

STATIC_URL = '/static/'

# 開発環境で静的ファイルを参照する先
STATICFILES_DIRS = [os.path.join(BASE_DIR, 'static')]  # 追加

# 本番環境で静的ファイルを参照する先
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')  # 追加

# メディアファイルpath
MEDIA_URL = '/media/'

```

この設定で開発サーバーが起動するかどうか確認する

```sh
python manage.py runserver
```

問題なく起動できた。
ログイン機能を作成する前にbootstrapのファイルをstaticフォルダに格納しておく。
.envに環境変数は避難したのでcommitする。

```sh
git add .
git commit - m "start animal classification django-project"
```

### 2. ログイン機能の作成

ログイン機能はdjango-allauthとカスタムユーザーを使用する。
カスタムユーザーモデルを使った認証は次のステップを踏む。

2.1. `users`アプリを作成
2.2 `CustomUser`モデルを作成
2.3 `settings.py`を更新
2.4 `UserCreationForm`と`UserChangeForm`をカスタマイズ
2.5 `admin.py`にカスタムユーザーモデルを追加する。
2.6 マイグレーションとsuperuser
2.8 django-allauthの設定
2.7 テンプレートの作成
2.9 django-allauthでEmail-Onlyログイン化

#### 2.1. `users`アプリを作成

カスタムユーザー用に`users`アプリを作成する。

```sh
python manage.py startapp users
```

#### 2.2 `CustomUser`モデルを作成

users/models.pyにカスタムユーザーモデルの情報を定義する。
`AbstractBaseUser`か`AbstractUser`を継承するが、`AbstractUser`の方がデフォルトの`User`フィールドを
保持したまま設定できる。今回は`AbstractUser`を継承する。

```python
# users/models.py

from django.contrib.auth.models import AbstractUser
from django.db import models


class CustormUser(AbstractUser):
    """拡張ユーザーモデル"""

    class Meta(AbstractUser.Meta):
        db_table = 'custom_user'

    # 年齢を追加したい場合
    # age = models.IntegerField('年齢', blank=True, null=True)

```

#### 2.3 `settings.py`を更新

settings.pyにusersアプリを追加する。

```python
# config/settings.py

# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',

    # Local
    'users.apps.UsersConfig',  # 追加
]

##################
# Authentication #
##################

AUTH_USER_MODEL = 'users.CustomUser'  # 追加
```

#### 2.4 `UserCreationForm`と`UserChangeForm`をカスタマイズ

forms.pyを作成してユーザー情報の登録内容のフォームを作成する。

```sh
type nul > users/forms.py
```

```python
# users/forms.py

"""
usernameを追加せずにemailとpasswordだけの認証にしたいが、それはdjango-allauthの設定で行う。
"""

from django.contrib.auth import get_user_model
from django.contrib.auth.forms import UserCreationForm, UserChangeForm


class CustomUserCreationForm(UserCreationForm):

    class Meta:
        model = get_user_model()  # AUTH_USER_MODEL config in settings.py
        fields = ('email', 'username')  # password is default


class CustomUserChangeForm(UserChangeForm):

    class Meta:
        model = get_user_model()  # AUTH_USER_MODEL config in settings.py
        fields = ('email', 'username')  # password is default

```

#### 2.5 `admin.py`にカスタムユーザーモデルを追加する。

このCustomUserモデルをadmin.pyで確認できるようにする。

```python
# users/admin.py

from django.contrib import admin
from django.contrib.auth import get_user_model
from django.contrib.auth.admin import UserAdmin

from .forms import CustomUserCreationForm, CustomUserChangeForm

CustomUser = get_user_model()


class CustomUserAdmin(UserAdmin):
    add_form = CustomUserCreationForm
    form = CustomUserChangeForm
    model = CustomUser

    list_display = ['email', 'username', 'is_staff']
    search_fields = ('first_name', 'last_name', 'email')
    ordering = ('email', )


admin.site.register(CustomUser, CustomUserAdmin)

```

usersアプリケーションでカスタムユーザーモデルの設定を行い、デフォルトの`django.contrib.auth`で
ログイン、ログアウトはできるようになった。サインアップだけはusers/views.pyに処理を作成する。

今回は`django.contrib.auth`ではなく`django-allauth`を使用して丸っと認証の設定を行う。

ここでコミットしておく。

#### 2.6 マイグレーションとsuperuser

```sh
python manage.py makemigrations
python manage.py migrate

# 管理者作成
python manage.py createsuperuser

# アクセスして確認してみる
python manage.py runserver
```

確かにカスタムユーザーのテーブルができていることが確認できる。

#### 2.7 django-allauthの設定

サードパーティ製のdjango-allauthを使って認証機能を追加する。
settings.pyのAPPSに追加する。

**EMAIL_BACKENDS**
djangoはメールを送るためにsmtpサーバーの設定を探しに行くので設定を加えたいが、
まだSMTPサーバーを用意していない場合、エラーが起きてしまう。
ということでSMTPサーバーが用意できるまではメールの内容をコンソールに出力されるように設定しておく。

```python
# config/settings.py

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'django.contrib.sites',  # 追加

    # Third-party
    'crispy_forms',  # 追加
    'allauth',  # 追加
    'allauth.account',  # 追加

    # Local
    'users.apps.UsersConfig',  # 追加
]

# ～～～省略～～～～

##################
# Authentication #
##################

AUTH_USER_MODEL = 'users.CustomUser'  # 追加

SITE_ID = 1  # 追加

AUTHENTICATION_BACKENDS = (
    'django.contrib.auth.backends.ModelBackend',  # default
    'allauth.account.auth_backends.AuthenticationBackend',  # 追加
)

EMAIL_BACKENDS = 'django.core.mail.backends.console.EmailBackend'  # 追加

LOGIN_REDIRECT_URL = 'index'
ACCOUNT_LOGOUT_REDIRECT = 'accounts/login'
```

allauthを追加したので、migrateする必要がある。

```sh
python manage.py migrate
```

#### 2.8 URLsを追加する

authアップと同じようにdjango-allauthも'accounts/'以下を使用する。

```python
# config/urls.py

from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    # User management
    path('account/', include('allauth.urls')),  # 追加
]
```

とりあえずこれでLogin, Logout, SingUpを進めてみる。

#### 2.9 テンプレートの作成

下記のファイルを作成していく。
templates/base.html
templates/account/login.html
templates/account/logout.html
templates/account/signup.html

```sh
type nul > templates/base.html
type nul > templates/account/login.html
type nul > templates/account/logout.html
type nul > templates/account/singup.html
```

```html
<!-- templates/base.html -->
{% load static %}

<!DOCTYPE html>
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>{% block title %}{% endblock title %}</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}">
    </head>
    <body>
        <nav class="navbar navbar-expand-md navbar-dark bg-dark">
            <a class="navbar-brand" href="{% url 'animal_cf:index' %}">Animal Classification</a>
            {% if user.is_authenticated %}
                <a class="btn btn-outline-primary" href="{% url 'account_logout' %}">ログアウト</a>
            {% else %}
                <!-- <a class="btn btn-outline-primary" href="{% url 'account_login' %}">ログイン</a> -->
                <a class="btn btn-outline-primary" href="{% url 'account_signup' %}">アカウント登録</a>
            {% endif %}
        </nav>
        <br>
        <div class="container">
            {% block content %}
            {% endblock content %}
        </div>
        <script src="{% static 'js/jquery-3.4.1.min.js' %}"></script>
        <script src="{% static 'js/bootstrap.js' %}"></script>
    </body>
</html>
```

```html
<!-- templates/account/login.html -->

{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}
  ログイン
{% endblock title %}

{% block content %}
  <h2>ログイン</h2>
  <form method='post'>
      {% csrf_token %}
      {{ form|crispy }}
      <button class="btn btn-success" type="submit">Log In</button>
  </form>
{% endblock content %}
```

```html
<!-- templates/account/login.html -->

{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}
  LogOut
{% endblock title %}

{% block content %}
  <h2>ログアウトします</h2>
  <form method='post'>
      {% csrf_token %}
      {{ form|crispy }}
      <button class="btn btn-success" type="submit">ログアウト</button>
  </form>
{% endblock content %}
```

```html
<!-- templates/account/signup.html -->

{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
  <h2>Sign Up</h2>
  <form method='post'>
      {% csrf_token %}
      {{ form|crispy }}
      <button class="btn btn-success" type="submit">Sign Up</button>
  </form>
{% endblock content %}
```

settings.pyも少し変更する。

```python

LOGIN_REDIRECT_URL = '/'
ACCOUNT_LOGOUT_REDIRECT = 'accounts/login/'
ACCOUNT_LOGOUT_ON_GET = True  # logout時にlogout.htmlに飛ばない設定

# django-crispy-forms
CRISPY_TEMPLATE_PACK = 'bootstrap4'
```

#### 2.10 django-allauthでEmail-Onlyログイン化

Django-allauthであれば設定を追加するだけで簡単に実現できる。
- ユーザー名は必要ない
- メールアドレスはユニークなもの
- メールアドレスは必須。

```python
# 認証方式をメールアドレスとパスワードに変更
ACCOUNT_AUTHENTICATION_METHOD = 'email'  # 追加

# ユーザー名は使用する
ACCOUNT_USERNAME_REQUIRED = True  # 追加
# ACCOUNT_USER_MODEL_USERNAME_FIELD = None

# メールアドレスを必須項目にする
ACCOUNT_EMAIL_REQUIRED = True  # 追加

# ユーザー登録確認メールは送信しない
ACCOUNT_EMAIL_VERIFICATION = 'none'

# メールアドレスをユニークなものにする
ACCOUNT_UNIQUE_EMAIL = True  # 追加

# signupformを指定
ACCOUNT_FORMS = {
    'signup': 'users.forms.CustomSignupForm'
}

# signupformからの情報をCustomUserModelに保存するための設定
ACCOUNT_ADAPTER = 'users.adapter.AccountAdapter'

# passwordの入力を1回に
ACCOUNT_SIGNUP_PASSWORD_ENTER_TWICE = False
```

settings.pyにdjango-allauthに必要なものを追加する。

とくにusers/adapter.pyを以下のように追加してカスタムユーザーモデルを追加できるようにする

```python
# users/adapter.py

from allauth.account.adapter import DefaultAccountAdapter


class AccountAdapter(DefaultAccountAdapter):

    def save_user(self, request, user, form, commit=True):
        user = super(AccountAdapter, self).save_user(request, user, form, commit=False)
        user.age = form.cleaned_data.get('get')
        user.weight = form.cleaned_data.get('weight')
        user.save()
```

これに合わせてforms.pyを更新する

```python
# users/forms.py

"""
usernameを追加せずにemailとpasswordだけの認証にしたいが、それはdjango-allauthの設定で行う。
"""

from django.contrib.auth import get_user_model
from django.contrib.auth.forms import UserCreationForm, UserChangeForm
from allauth.account.forms import SignupForm
from allauth.account.adapter import DefaultAccountAdapter
from django import forms


class CustomUserCreationForm(UserCreationForm):

    class Meta:
        model = get_user_model()  # AUTH_USER_MODEL config in settings.py
        fields = ('email', 'username')  # password is default


class CustomUserChangeForm(UserChangeForm):

    class Meta:
        model = get_user_model()  # AUTH_USER_MODEL config in settings.py
        fields = ('email', 'username')  # password is default


class CustomSignupForm(SignupForm):
    age = forms.IntegerField()
    weight = forms.IntegerField()

    class Meta:
        model = get_user_model()

    def signup(self, request, user):
        user.age = self.cleaned_data['age']
        user.weight = self.cleaned_data['weight']
        user.save()
        return user
```

emailによる認証機能を追加していく。django-allauthのEmail設定機能をカスタマイズするために
テンプレートを見つける必要があり、それらを上書きする形で利用する。
これらには二つのファイルがあり、account/email下に設置する。

```sh
mkdir templates/account/email
type nul > templates/account/email/email_confirmation_subject.txt
type nul > templates/account/email/email_confirmation_message.txt
```

django-allauthが持つSubjectラインのデフォルトは次のようになる。

```txt
# templates/account/email/email_confirmation_subject.txt
{% load i18n %}  # 他言語への対応
{% autoescape off %}
{% blocktrans %}Please Confirm Your E-mail Address {% endblocktrans %}
{% endautoescape %}
```

このtransブロックの中身を変更していく。こんな風にしてみる。


```txt
# templates/account/email/email_confirmation_subject.txt
{% load i18n %}  # 他言語への対応
{% autoescape off %}
{% blocktrans %}Confirm Your SignUp! {% endblocktrans %}
{% endautoescape %}
```

続いてmessageの方を変更する。


```txt
# templates/account/email/email_confirmation_messaage.txt
{% load account %}{% user_display user as user_display %}{% load i18n %}
{% autoescape off %}{% blocktrans with site_name=current_site.name site_domain=surrent_site.domain %}Hello from {{ site_name }}!

You're receiving this e-mail becouse user {{ user_display }} has given yours\
as an email address to connect their account.

To confirm this is correct, go to {{ active_url }}
{% endblocktrans %}{% endautoescape %}
{% block trans with site_name=current_site.name site_domain=current_site.domain %}Thank you from {{site_name}} !

{{  site_domain }}{% endblocktrans %}

```

{{ site_domain }}や{{ site_name }}はadmin画面のsiteの内容を利用している。
adminからドメイン名と表示名を下記のように変更する。

- ドメイン名: example.com ⇒ animal_cf.com
- 表示名: animal_cf.com

最後にDEFAULT_FROM_EMAILを変更する。

```python
# config/settings.py
DEFAULT_FROM_EMAIL = 'admin@animal_cf.com'
```

メール確認画面を作成する。

```sh
cd templates/account
type nul > email_confirm.html
```

メールアドレスを登録  
⇒アカウント登録  
⇒認証メールで確認  
⇒認証完了  
⇒ログイン完了

確認画面をaccount/email_confirm.htmlとして作成する。

```html
<!-- templates/account/email_confirm.html -->

{% extends 'base.html' %}

{% load i18n %}
{% load account %}

{% block head_title %}{% trans "Confirm E-mail Address" %}{% endblock %}


{% block content %}
<h1>{% trans "Confirm E-mail Address" %}</h1>

{% if confirmation %}

{% user_display confirmation.email_address.user as user_display %}

<p>{% blocktrans with confirmation.email_address.email as email %}Please confirm
that <a href="mailto:{{ email }}">{{ email }}</a> is an e-mail address for user
{{ user_display }}.{% endblocktrans %}</p>

<form method="post" action="{% url 'account_confirm_email' confirmation.key %}">
{% csrf_token %}
  <button class="btn btn-primary" type="submit">{% trans 'Confirm' %}</button>
</form>

{% else %}

{% url 'account_email' as email_url %}

<p>{% blocktrans %}This e-mail confirmation link expired or is invalid. Please
<a href="{{ email_url }}">issue a new e-mail confirmation request</a>.
{% endblocktrans %}</p>

{% endif %}

{% endblock %}
```

パスワードのリセットやパスワードの変更についてはdjango-allauthを確認して
追加実装していく予定。

### 3. 画像分類アプリの作成

ここから肝心の動物の画像分類アプリを作成していく。
画像を投稿する機能を作成するので、animal/models.pyにイメージフィールドを定義する。

```python
# animal_cf/models.py

from django.db import models

# Create your models here.


class AnimalImage(models.Model):

    class Meta:
        db_table = 'animal_image'

    animal_image = models.ImageField(
        verbose_name = 'イメージ',
        blank=True, null=True,
        upload_to = 'images/'
    )

```

モデルを更新したので、makemigrationsを行う。

```sh
python manage.py makemigrations animal_cf
SystemCheckError: System check identified some issues:

ERRORS:
animal_cf.AnimalImage.animal_image: (fields.E210) Cannot use ImageField because Pillow is not installed.
        HINT: Get Pillow at https://pypi.org/project/Pillow/ or run command "python -m pip install Pillow".

# Pillowが無いと怒られたので,Pillowをインストールする。
pip install Pillow

# 気を取り直して
python manage.py makemigrations animal_cf
python manage.py migrate
```

modelを作成したので、formを作成する。

```python
# animal_cf/forms.py

from django import forms
from .models import AnimalImage


class AnimalImageForm(forms.ModelForm):

    class Meta:
        model = AnimalImage
        fields = ('animal_image', )

```

forms.pyを作成したので、テンプレートにformを返してみる。

```python
# animal_cf/views.py

from django.shortcuts import render, redirect, reverse
from django.contrib.auth.decorators import login_required  # 追加
from django.conf import settings as settings
from .models import AnimalImage
from .forms import AnimalImageForm


@login_required
def index(request):
    if request.method == 'GET':
        msg = '動物の画像を洗濯してください'
        form = AnimalImageForm
        params = {
            'msg': msg,
            'form': form,
        }
        return render(request, 'animal_cf/index.html', params)
```

テンプレート側に画像投稿のformを作成する。

```html
<!-- templates/animal_cf/index.html -->

{% extends "base.html" %}

{% load static %}
{% load crispy_forms_tags %}

{% block title %}
  animal classification
{% endblock title %}

{% block content %}
  {% if user.is_authenticated %}
    <p>Hi {{ user.username }}!</p>
    <h1>{{ msg }}</h1>
    <form method="post">
      {% csrf_token %}
      {{ form.as_p }}
      <button class="btn btn-primary" type="submit" >投稿</button>
    </form>
  {% else %}
    <p>You are not logged in</p>
    <p><a href="{% url 'account_login' %}">ログイン</a></p>
    <a href="{% url 'account_signup' %}">アカウント登録</a>
  {% endif %}
{% endblock content %}
```

開発用サーバで確認したら感じになった。

